# å‚·å®³åˆ¤å®šé‚è¼¯

## æ ¸å¿ƒè¦å‰‡

### ä¸»å‹• vs è¢«å‹•ç§»å‹•

åªæœ‰**ä¸»å‹•æ”»æ“Šè€…ï¼ˆActive Attackerï¼‰**æ‰èƒ½é€ æˆå‚·å®³ã€‚

```gdscript
is_active_attacker = true   // å¯ä»¥é€ æˆå‚·å®³
is_active_attacker = false  // ä¸èƒ½é€ æˆå‚·å®³ï¼ˆåªæœ‰ç‰©ç†æ¨å‹•ï¼‰
```

## è©³ç´°è¦å‰‡

### 1. æˆ‘æ–¹è¡Œå‹•æ™‚

#### è¦å‰‡ 1.1ï¼šç©å®¶ç›´æ¥ç¢°æ’æ•µäºº
```
ç©å®¶ï¼ˆä¸»å‹•ï¼‰â”â”â”> ğŸ’¥ æ•µäºº A
                    â†“
                 æ•µäºº A å—å‚· âœ“
                    â†“
                 æ•µäºº A è¢«æ¨å‹•ï¼ˆè®Šç‚ºè¢«å‹•ï¼‰
```

**é‚è¼¯**ï¼š
- ç©å®¶ï¼š`is_active_attacker = true`ï¼ˆlaunch æ™‚è¨­å®šï¼‰
- ç¢°æ’æ•µäºº Aï¼šé€ æˆå‚·å®³ âœ“
- æ•µäºº Aï¼š`is_active_attacker = false`ï¼ˆknockback æ™‚è¨­å®šï¼‰

#### è¦å‰‡ 1.2ï¼šè¢«æ¨å‹•çš„æ•µäººç¢°æ’å…¶ä»–æ•µäºº
```
ç©å®¶ â”â”â”> æ•µäºº Aï¼ˆè¢«æ¨å‹•ï¼‰â”â”â”> ğŸ’¥ æ•µäºº B
                                    â†“
                                æ•µäºº B ä¸å—å‚· âœ—
                                    â†“
                                æ•µäºº B è¢«æ¨å‹•ï¼ˆç‰©ç†æ•ˆæœï¼‰
```

**é‚è¼¯**ï¼š
- æ•µäºº Aï¼š`is_active_attacker = false`ï¼ˆè¢«æ¨å‹•ï¼‰
- ç¢°æ’æ•µäºº Bï¼š**ä¸é€ æˆå‚·å®³** âœ—ï¼ˆåªæœ‰ç‰©ç†æ¨å‹•ï¼‰
- åŸå› ï¼šæ•µäºº A ä¸æ˜¯ä¸»å‹•æ”»æ“Šè€…

#### è¦å‰‡ 1.3ï¼šé€£é–æ¨å‹•
```
ç©å®¶ â”â”â”> æ•µäºº A â”â”â”> æ•µäºº B â”â”â”> æ•µäºº C
           å—å‚· âœ“    ä¸å—å‚· âœ—    ä¸å—å‚· âœ—
           è¢«æ¨å‹•     è¢«æ¨å‹•       è¢«æ¨å‹•
          (è¢«å‹•)     (è¢«å‹•)       (è¢«å‹•)
```

**çµæœ**ï¼š
- æ•µäºº Aï¼šå—å‚· âœ“ï¼ˆè¢«ç©å®¶ç›´æ¥ç¢°æ’ï¼‰
- æ•µäºº Bï¼šä¸å—å‚· âœ—ï¼ˆè¢«è¢«å‹•çš„æ•µäºº A ç¢°æ’ï¼‰
- æ•µäºº Cï¼šä¸å—å‚· âœ—ï¼ˆè¢«è¢«å‹•çš„æ•µäºº B ç¢°æ’ï¼‰

### 2. æ•µæ–¹è¡Œå‹•æ™‚

#### è¦å‰‡ 2.1ï¼šä¸»å‹•è¡Œå‹•çš„æ•µäººç¢°æ’ç©å®¶
```
æ•µäºº Aï¼ˆä¸»å‹•è¡Œå‹•ï¼‰â”â”â”> ğŸ’¥ ç©å®¶
                         â†“
                      ç©å®¶å—å‚· âœ“
                         â†“
                      ç©å®¶è¢«æ¨å‹•ï¼ˆè®Šç‚ºè¢«å‹•ï¼‰
```

**é‚è¼¯**ï¼š
- æ•µäºº Aï¼š`is_active_attacker = true`ï¼ˆlaunch æ™‚è¨­å®šï¼‰
- ç¢°æ’ç©å®¶ï¼šé€ æˆå‚·å®³ âœ“
- ç©å®¶ï¼š`is_active_attacker = false`ï¼ˆknockback æ™‚è¨­å®šï¼‰

#### è¦å‰‡ 2.2ï¼šä¸»å‹•æ•µäººæ¨å‹•å…¶ä»–æ•µäºº
```
æ•µäºº Aï¼ˆä¸»å‹•ï¼‰â”â”â”> ğŸ’¥ æ•µäºº Bï¼ˆéœæ­¢ï¼‰
                        â†“
                    æ•µäºº B ä¸å—å‚· âœ—
                        â†“
                    æ•µäºº B è¢«æ¨å‹•ï¼ˆè®Šç‚ºè¢«å‹•ï¼‰
```

**é‚è¼¯**ï¼š
- æ•µäºº Aï¼š`is_active_attacker = true`
- ç¢°æ’æ•µäºº Bï¼š**ä¸é€ æˆå‚·å®³** âœ—ï¼ˆæ•µäººä¹‹é–“æ°¸é ä¸äº’ç›¸å‚·å®³ï¼‰
- æ•µäºº Bï¼š`is_active_attacker = false`ï¼ˆè¢«æ¨å‹•ï¼‰

#### è¦å‰‡ 2.3ï¼šè¢«æ¨å‹•çš„æ•µäººç¢°æ’ç©å®¶
```
æ•µäºº Aï¼ˆä¸»å‹•ï¼‰â”â”â”> æ•µäºº Bï¼ˆè¢«æ¨å‹•ï¼‰â”â”â”> ğŸ’¥ ç©å®¶
                                          â†“
                                      ç©å®¶å—å‚· âœ“
```

**é‚è¼¯**ï¼š
- æ•µäºº Aï¼š`is_active_attacker = true`ï¼ˆä¸»å‹•è¡Œå‹•ï¼‰
- æ•µäºº Bï¼š`is_active_attacker = false`ï¼ˆè¢«æ¨å‹•ï¼‰
- æ•µäºº B ç¢°ç©å®¶ï¼š**é€ æˆå‚·å®³** âœ“

**ç‰¹åˆ¥æ³¨æ„**ï¼šé€™æ˜¯å”¯ä¸€çš„ä¾‹å¤–ï¼
- åŸå› ï¼šæºé ­æ˜¯æ•µäºº A çš„ä¸»å‹•è¡Œå‹•
- å¯¦ç¾æ–¹å¼ï¼šç”±æ–¼ç‰©ç†å¼•æ“çš„é€£é–æ•ˆæœï¼Œæ•µäºº B çš„é€Ÿåº¦ä¾†è‡ªæ•µäºº A
- åˆ¤å®šæ–¹å¼ï¼šåªè¦ `is_moving = true` ä¸”ç¢°åˆ°ç©å®¶ï¼Œå°±é€ æˆå‚·å®³

**ç­‰ç­‰ï¼Œéœ€è¦ä¿®æ­£ï¼**

æ ¹æ“šä½ çš„ç¢ºèªï¼ˆ3.Bï¼‰ï¼Œé€™ç¨®æƒ…æ³æ‡‰è©²é€ æˆå‚·å®³ã€‚ä½†æˆ‘ç›®å‰çš„å¯¦ç¾æœƒé˜»æ­¢é€™ç¨®æƒ…æ³ï¼

è®“æˆ‘é‡æ–°æ€è€ƒ...

## æ­£ç¢ºçš„å¯¦ç¾é‚è¼¯

### é‡æ–°åˆ†æè¦å‰‡

**ç©å®¶è¢«ç¢°æ’**ï¼š
- æ•µäººï¼ˆä¸»å‹•ï¼‰â†’ ç©å®¶ï¼šå—å‚· âœ“
- æ•µäººï¼ˆè¢«æ¨å‹•ï¼‰â†’ ç©å®¶ï¼šå—å‚· âœ“ï¼ˆå› ç‚ºæºé ­æ˜¯æ•µæ–¹è¡Œå‹•ï¼‰

**æ•µäººè¢«ç¢°æ’**ï¼š
- ç©å®¶ï¼ˆä¸»å‹•ï¼‰â†’ æ•µäººï¼šå—å‚· âœ“
- æ•µäººï¼ˆè¢«æ¨å‹•ï¼‰â†’ æ•µäººï¼šä¸å—å‚· âœ—

### ä¿®æ­£å¾Œçš„è¦å‰‡

```gdscript
if body.is_in_group("enemy") and is_player_unit:
    # ç©å®¶ç¢°æ•µäºº
    if is_active_attacker:
        é€ æˆå‚·å®³ âœ“
    else:
        ä¸é€ æˆå‚·å®³ âœ—

elif body.is_in_group("player") and not is_player_unit:
    # æ•µäººç¢°ç©å®¶
    if is_moving:  # åªè¦æ•µäººåœ¨ç§»å‹•å°±é€ æˆå‚·å®³ï¼ˆä¸ç®¡ä¸»å‹•è¢«å‹•ï¼‰
        é€ æˆå‚·å®³ âœ“
    else:
        ä¸é€ æˆå‚·å®³ âœ—

elif body.is_in_group("enemy") and not is_player_unit:
    # æ•µäººç¢°æ•µäºº
    æ°¸é ä¸é€ æˆå‚·å®³ âœ—ï¼ˆåªæœ‰ç‰©ç†æ•ˆæœï¼‰
```

## ç¢°æ’åˆ¤å®šè¡¨

| ç¢°æ’è€… | è¢«ç¢°è€… | ç¢°æ’è€…ç‹€æ…‹ | é€ æˆå‚·å®³ï¼Ÿ | èªªæ˜ |
|--------|--------|-----------|-----------|------|
| ç©å®¶ | æ•µäºº | ä¸»å‹• | âœ“ æ˜¯ | ç©å®¶æ”»æ“Š |
| ç©å®¶ | æ•µäºº | è¢«å‹• | âœ— å¦ | ç©å®¶è¢«æ¨å‹• |
| æ•µäºº | ç©å®¶ | ä¸»å‹• | âœ“ æ˜¯ | æ•µäººä¸»å‹•æ”»æ“Š |
| æ•µäºº | ç©å®¶ | è¢«å‹• | âœ“ æ˜¯ | é€£é–å‚·å®³ |
| æ•µäºº | æ•µäºº | ä¸»å‹• | âœ— å¦ | æ•µäººé–“ä¸äº’å‚· |
| æ•µäºº | æ•µäºº | è¢«å‹• | âœ— å¦ | æ•µäººé–“ä¸äº’å‚· |

## å¯¦ç¾ç´°ç¯€

### æ–°å¢è®Šæ•¸
```gdscript
var is_active_attacker: bool = false  # æ˜¯å¦ç‚ºä¸»å‹•æ”»æ“Šè€…
```

### Launchï¼ˆä¸»å‹•ç™¼å°„ï¼‰
```gdscript
func launch(direction: Vector2, power: float):
    linear_velocity = ...
    is_moving = true
    is_active_attacker = true  # è¨­ç‚ºä¸»å‹•æ”»æ“Šè€…
    print("[Launch] ", unit_name, " launched as ACTIVE ATTACKER")
```

### Knockbackï¼ˆè¢«æ¨å‹•ï¼‰
```gdscript
func _apply_knockback(target, speed_scale: float):
    target.linear_velocity = ...
    target.is_moving = true
    target.is_active_attacker = false  # è¨­ç‚ºè¢«å‹•ç§»å‹•
    print("[Knockback] Target is now PASSIVE (cannot deal damage)")
```

### Stop Movementï¼ˆåœæ­¢ï¼‰
```gdscript
func stop_movement():
    is_moving = false
    is_active_attacker = false  # æ¸…é™¤æ”»æ“Šè€…ç‹€æ…‹
```

### ç¢°æ’åˆ¤å®šï¼ˆå·²å¯¦ç¾ï¼‰âœ“
```gdscript
func _on_body_entered(body):
    if not collision_enabled or not is_moving:
        return

    if body.is_in_group("enemy") and is_player_unit:
        # ç©å®¶ç¢°æ•µäººï¼šåªæœ‰ä¸»å‹•æ‰èƒ½é€ æˆå‚·å®³
        if is_active_attacker:
            _handle_enemy_collision(body)
        else:
            print("ç©å®¶è¢«å‹•ç§»å‹•ï¼Œä¸é€ æˆå‚·å®³")

    elif body.is_in_group("player") and not is_player_unit:
        # æ•µäººç¢°ç©å®¶ï¼šåªè¦åœ¨ç§»å‹•å°±é€ æˆå‚·å®³ï¼ˆä¸»å‹•æˆ–è¢«å‹•éƒ½è¡Œï¼‰
        _handle_player_collision(body)

    elif body.is_in_group("enemy") and not is_player_unit:
        # æ•µäººç¢°æ•µäººï¼šæ°¸é ä¸é€ æˆå‚·å®³
        _handle_enemy_to_enemy_collision(body)
```

## å ´æ™¯ç¤ºä¾‹

### å ´æ™¯ 1ï¼šç©å®¶é€£æ“Š
```
ç©å®¶ â”â”â”> æ•µ A ğŸ’¥ â”â”â”> æ•µ B ğŸ’¥ â”â”â”> æ•µ C
         å—å‚· âœ“        ä¸å‚· âœ—       ä¸å‚· âœ—
         è¢«æ¨(è¢«å‹•)    è¢«æ¨(è¢«å‹•)    è¢«æ¨(è¢«å‹•)
```

### å ´æ™¯ 2ï¼šæ•µäººé€£é–æ”»æ“Š
```
æ•µ A(ä¸»å‹•) â”â”â”> æ•µ B ğŸ’¥ â”â”â”> ç©å®¶ ğŸ’¥
              ä¸å‚· âœ—         å—å‚· âœ“
              è¢«æ¨(è¢«å‹•)     è¢«æ¨(è¢«å‹•)
```

**æ•µ B è®Šè¢«å‹•ï¼Œä½†ç¢°åˆ°ç©å®¶ä»é€ æˆå‚·å®³ï¼**

### å ´æ™¯ 3ï¼šä¿é½¡çƒæ•ˆæœ
```
ç©å®¶ â”â”â”> æ•µ A â”â”â”> æ•µ B â”â”â”> æ•µ C
         âœ“        âœ—        âœ—

åªæœ‰æ•µ A å—å‚·ï¼
```

### å ´æ™¯ 4ï¼šæ•µæ–¹ä¿é½¡çƒ
```
æ•µ A(ä¸»å‹•) â”â”â”> æ•µ B â”â”â”> æ•µ C â”â”â”> ç©å®¶
                âœ—        âœ—         âœ“

æ•µäººä¸äº’å‚·ï¼Œä½†æœ€å¾Œç©å®¶å—å‚·ï¼
```

## Debug è¨Šæ¯

### Launch è¨Šæ¯
```
[Launch] Player Unit launched as ACTIVE ATTACKER
[Launch] Red Dragon launched as ACTIVE ATTACKER
```

### Knockback è¨Šæ¯
```
[Knockback] Player Unit knocked back Blue Slime with power 1200 (speed scale: 0.80) - Target is now PASSIVE (cannot deal damage)
```

### Collision è¨Šæ¯
```
[Enemy Collision] Red Dragon pushed Green Goblin (PASSIVE)
```

### Damage è¨Šæ¯
```
=== Damage Info ===
Attacker: Player Unit (RED)
Target: Blue Slime (BLUE)
Speed Scale: 0.80
Attribute Multiplier: 0.50
Buff Multiplier: 1.00
Weakness Hit: false
Final Damage: 40
==================
```

## ä¿®æ”¹çš„æª”æ¡ˆ

**scripts/Unit.gd**
1. æ–°å¢ `is_active_attacker` è®Šæ•¸
2. `launch()` è¨­å®š `is_active_attacker = true`
3. `stop_movement()` æ¸…é™¤ `is_active_attacker = false`
4. `_apply_knockback()` è¨­å®š `target.is_active_attacker = false`
5. `_handle_enemy_to_enemy_collision()` è¨­å®šè¢«æ¨å‹•æ•µäººç‚ºè¢«å‹•
6. `_on_body_entered()` ä¿®æ”¹åˆ¤å®šé‚è¼¯ âœ“

**DAMAGE_LOGIC.md** - å®Œæ•´çš„å‚·å®³åˆ¤å®šæ–‡æª”

## ç¸½çµ

**å¯¦ç¾å®Œæˆ** âœ“

**æ ¸å¿ƒé‚è¼¯**ï¼š
- âœ… ç©å®¶ï¼ˆä¸»å‹•ï¼‰â†’ æ•µäººï¼šé€ æˆå‚·å®³
- âœ… ç©å®¶ï¼ˆè¢«å‹•ï¼‰â†’ æ•µäººï¼šä¸é€ æˆå‚·å®³
- âœ… æ•µäººï¼ˆä¸»å‹•ï¼‰â†’ ç©å®¶ï¼šé€ æˆå‚·å®³
- âœ… æ•µäººï¼ˆè¢«å‹•ï¼‰â†’ ç©å®¶ï¼šé€ æˆå‚·å®³ï¼ˆé€£é–æ•ˆæœï¼‰
- âœ… æ•µäºº â†’ æ•µäººï¼šæ°¸é ä¸é€ æˆå‚·å®³

**ç¾åœ¨å‚·å®³åˆ¤å®šé‚è¼¯å®Œå…¨ç¬¦åˆéœ€æ±‚ï¼**
