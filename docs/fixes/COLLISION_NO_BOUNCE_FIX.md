# ç¢°æ’ä¸å›å½ˆä¿®æ­£

## å•é¡Œæè¿°

ç•¶ç©å®¶ç¢°åˆ°æ•µäººæ™‚ï¼Œæ•µäººæœƒè¢«ç‰©ç†å¼•æ“å½ˆé–‹ï¼ˆå›å½ˆï¼‰ã€‚é€™æ˜¯å› ç‚ºä½¿ç”¨äº† `RigidBody2D`ï¼Œç‰©ç†å¼•æ“æœƒè‡ªå‹•è™•ç†ç¢°æ’åæ‡‰ã€‚

## å•é¡ŒåŸå› 

### RigidBody2D çš„ç¢°æ’è¡Œç‚º

```
ç©å®¶ â†’ ç¢°åˆ°æ•µäºº

ç‰©ç†å¼•æ“è‡ªå‹•è™•ç†ï¼š
1. æª¢æ¸¬ç¢°æ’
2. è¨ˆç®—è¡é‡ï¼ˆimpulseï¼‰
3. å°é›™æ–¹æ–½åŠ åˆ†é›¢åŠ›
4. çµæœï¼šé›™æ–¹éƒ½è¢«å½ˆé–‹
```

### è¦–è¦ºåŒ–

```
ç¢°æ’å‰ï¼š
  ğŸ”´ â”â”â†’  ğŸ”µ (ç©å®¶ç§»å‹•ï¼Œæ•µäººéœæ­¢)

ç¢°æ’ç¬é–“ï¼š
  ğŸ”´ ğŸ’¥ ğŸ”µ (ç‰©ç†å¼•æ“åµæ¸¬ç¢°æ’)

ç‰©ç†å¼•æ“è™•ç†ï¼š
  ğŸ”´ â† âš¡ âš¡ â†’ ğŸ”µ (ç”¢ç”Ÿåˆ†é›¢åŠ›)

ç¢°æ’å¾Œï¼š
  ğŸ”´ â†â”  â”â†’ ğŸ”µ (é›™æ–¹éƒ½è¢«å½ˆé–‹) âŒ
```

## è§£æ±ºæ–¹æ¡ˆ

### ç­–ç•¥ï¼šè¨˜éŒ„ä½ç½® â†’ ç¢°æ’ â†’ æ¢å¾©ä½ç½®

åœ¨ç¢°æ’è™•ç†ä¸­ï¼š
1. **ç¢°æ’å‰**ï¼šè¨˜éŒ„è¢«æ“Šè€…çš„ä½ç½®å’Œé€Ÿåº¦
2. **ç¢°æ’æ™‚**ï¼šè¨ˆç®—ä¸¦é€ æˆå‚·å®³ï¼ˆç‰©ç†å¼•æ“è‡ªå‹•è™•ç†ç¢°æ’ï¼‰
3. **ç¢°æ’å¾Œ**ï¼šç­‰å¾…ä¸€å¹€ï¼Œç„¶å¾Œæ¢å¾©è¢«æ“Šè€…çš„ä½ç½®å’Œé€Ÿåº¦

### å¯¦ä½œç´°ç¯€

#### ç©å®¶ç¢°æ’æ•µäºº

```gdscript
func _handle_enemy_collision(enemy):
	if not enemy.has_method("take_damage"):
		return

	# 1. è¨˜éŒ„æ•µäººç¢°æ’å‰çš„ä½ç½®å’Œé€Ÿåº¦
	var enemy_position = enemy.global_position
	var enemy_velocity = enemy.linear_velocity
	var enemy_angular = enemy.angular_velocity

	# 2. è¨ˆç®—å‚·å®³
	var speed_scale = velocity_magnitude / MAX_SPEED
	var collision_point = global_position
	var is_weakness = _check_weakness(enemy, collision_point)

	var base_damage = atk * speed_scale
	var attr_multiplier = Attribute.get_multiplier(attribute, enemy.attribute)
	var buff_multiplier = _calculate_buff_multiplier()
	var weakness_multiplier = 1.5 if is_weakness else 1.0

	var final_damage = int(base_damage * attr_multiplier * buff_multiplier * weakness_multiplier)

	# 3. é€ æˆå‚·å®³
	enemy.take_damage(final_damage, is_weakness)
	damaged.emit(final_damage, is_weakness)

	# é¡¯ç¤ºå‚·å®³æµ®å­—
	_spawn_damage_label(enemy.global_position, final_damage, is_weakness)

	# ç´¯ç©æŠ€èƒ½é‡è¡¨
	if is_player_unit:
		var skill_gain = int(speed_scale * 20)
		get_tree().call_group("battle_controller", "add_skill_gauge", skill_gain)

	# 4. æ¢å¾©æ•µäººä½ç½®å’Œé€Ÿåº¦ï¼ˆé˜²æ­¢è¢«ç¢°æ’å›å½ˆï¼‰
	await get_tree().process_frame
	if is_instance_valid(enemy):
		enemy.global_position = enemy_position
		enemy.linear_velocity = enemy_velocity
		enemy.angular_velocity = enemy_angular
```

#### æ•µäººç¢°æ’ç©å®¶

```gdscript
func _handle_player_collision(player):
	if not player.has_method("take_damage"):
		return

	# 1. è¨˜éŒ„ç©å®¶ç¢°æ’å‰çš„ä½ç½®å’Œé€Ÿåº¦
	var player_position = player.global_position
	var player_velocity = player.linear_velocity
	var player_angular = player.angular_velocity

	# 2. è¨ˆç®—å‚·å®³
	var speed_scale = velocity_magnitude / MAX_SPEED
	var collision_point = global_position
	var is_weakness = _check_weakness(player, collision_point)

	var base_damage = atk * speed_scale
	var attr_multiplier = Attribute.get_multiplier(attribute, player.attribute)
	var buff_multiplier = _calculate_buff_multiplier()
	var weakness_multiplier = 1.5 if is_weakness else 1.0

	var final_damage = int(base_damage * attr_multiplier * buff_multiplier * weakness_multiplier)

	# 3. é€ æˆå‚·å®³
	player.take_damage(final_damage, is_weakness)

	# é¡¯ç¤ºå‚·å®³æµ®å­—
	_spawn_damage_label(player.global_position, final_damage, is_weakness)

	# 4. æ¢å¾©ç©å®¶ä½ç½®å’Œé€Ÿåº¦ï¼ˆé˜²æ­¢è¢«ç¢°æ’å›å½ˆï¼‰
	await get_tree().process_frame
	if is_instance_valid(player):
		player.global_position = player_position
		player.linear_velocity = player_velocity
		player.angular_velocity = player_angular
```

## æ™‚é–“è»¸èªªæ˜

### è©³ç´°æ­¥é©Ÿ

```
Frame N (ç¢°æ’ç™¼ç”Ÿ):
  1. _on_body_entered() è¢«è§¸ç™¼
  2. è¨˜éŒ„æ•µäººä½ç½®: position=(200, 100)
  3. è¨˜éŒ„æ•µäººé€Ÿåº¦: velocity=(0, 0)
  4. è¨ˆç®—ä¸¦é€ æˆå‚·å®³
  5. await get_tree().process_frame (æš«åœï¼Œç­‰å¾…ä¸‹ä¸€å¹€)

Frame N+1 (ç‰©ç†è™•ç†):
  - ç‰©ç†å¼•æ“è™•ç†ç¢°æ’
  - å°é›™æ–¹æ–½åŠ åˆ†é›¢åŠ›
  - ç©å®¶ä½ç½®æ”¹è®Š: (100, 100) â†’ (95, 98)
  - æ•µäººä½ç½®æ”¹è®Š: (200, 100) â†’ (205, 102) âŒ

Frame N+2 (æ¢å¾©ä½ç½®):
  - await çµæŸï¼Œç¹¼çºŒåŸ·è¡Œ
  - æ¢å¾©æ•µäººä½ç½®: (205, 102) â†’ (200, 100) âœ…
  - æ¢å¾©æ•µäººé€Ÿåº¦: (50, 20) â†’ (0, 0) âœ…
```

### ç‚ºä»€éº¼ç­‰å¾…ä¸€å¹€ï¼Ÿ

```
ç«‹å³æ¢å¾©ï¼ˆéŒ¯èª¤ï¼‰:
  è¨˜éŒ„ä½ç½® â†’ æ¢å¾©ä½ç½® â†’ ç‰©ç†å¼•æ“è™•ç†
  çµæœï¼šç‰©ç†å¼•æ“åœ¨æ¢å¾©å¾Œæ‰è™•ç†ï¼Œä»ç„¶æœƒæ”¹è®Šä½ç½® âŒ

ç­‰å¾…ä¸€å¹€ï¼ˆæ­£ç¢ºï¼‰:
  è¨˜éŒ„ä½ç½® â†’ ç‰©ç†å¼•æ“è™•ç† â†’ æ¢å¾©ä½ç½®
  çµæœï¼šç‰©ç†å¼•æ“çš„æ”¹è®Šè¢«è¦†è“‹ï¼Œä½ç½®æ¢å¾©æ­£ç¢º âœ…
```

## è¦–è¦ºåŒ–å°æ¯”

### ä¿®æ­£å‰ï¼ˆæœ‰å›å½ˆï¼‰

```
T=0: ç¢°æ’å‰
     ğŸ”´ â”â”â†’ velocity=(500, 0)
     ğŸ”µ     velocity=(0, 0)

T=1: ç¢°æ’ç™¼ç”Ÿ
     ğŸ”´ ğŸ’¥ ğŸ”µ
     è¨ˆç®—å‚·å®³ï¼š100 damage

T=2: ç‰©ç†å¼•æ“è™•ç†
     ğŸ”´ â†â”  velocity=(-200, 0) (åå½ˆ)
     ğŸ”µ  â”â†’ velocity=(300, 0)  (è¢«æ¨å‹•) âŒ

çµæœï¼š
     ğŸ”´ å¾€å›å½ˆ
     ğŸ”µ è¢«æ¨é–‹ âŒ
```

### ä¿®æ­£å¾Œï¼ˆç„¡å›å½ˆï¼‰

```
T=0: ç¢°æ’å‰
     ğŸ”´ â”â”â†’ velocity=(500, 0)
     ğŸ”µ     velocity=(0, 0)
     è¨˜éŒ„ï¼šenemy_position=(200, 100), enemy_velocity=(0, 0)

T=1: ç¢°æ’ç™¼ç”Ÿ
     ğŸ”´ ğŸ’¥ ğŸ”µ
     è¨ˆç®—å‚·å®³ï¼š100 damage
     await process_frame (ç­‰å¾…)

T=2: ç‰©ç†å¼•æ“è™•ç†
     ğŸ”´ â†â”  velocity=(-200, 0) (ç©å®¶åå½ˆ)
     ğŸ”µ  â”â†’ velocity=(300, 0)  (æ•µäººè¢«æ¨å‹•)
     position=(205, 102)

T=3: æ¢å¾©æ•µäººç‹€æ…‹
     ğŸ”µ â†’ æ¢å¾©åˆ° position=(200, 100) âœ…
     ğŸ”µ â†’ æ¢å¾©åˆ° velocity=(0, 0) âœ…

çµæœï¼š
     ğŸ”´ å¾€å›å½ˆï¼ˆæ­£å¸¸åå½ˆï¼‰
     ğŸ”µ ä½ç½®ä¸è®Š âœ…
```

## é—œéµè¦é»

### 1. åªæ¢å¾©è¢«æ“Šè€…ï¼Œä¸æ¢å¾©æ”»æ“Šè€…

```gdscript
# ç©å®¶ç¢°æ’æ•µäººï¼š
# - ç©å®¶ï¼šæ­£å¸¸åå½ˆï¼ˆä¸æ¢å¾©ï¼‰
# - æ•µäººï¼šä½ç½®ä¸è®Šï¼ˆæ¢å¾©ï¼‰

# æ•µäººç¢°æ’ç©å®¶ï¼š
# - æ•µäººï¼šæ­£å¸¸åå½ˆï¼ˆä¸æ¢å¾©ï¼‰
# - ç©å®¶ï¼šä½ç½®ä¸è®Šï¼ˆæ¢å¾©ï¼‰
```

### 2. ç­‰å¾…ä¸€å¹€è®“ç‰©ç†è™•ç†å®Œæˆ

```gdscript
await get_tree().process_frame
```

### 3. æª¢æŸ¥å¯¦ä¾‹æœ‰æ•ˆæ€§

```gdscript
if is_instance_valid(enemy):
    # æ¢å¾©ä½ç½®å’Œé€Ÿåº¦
```

é˜²æ­¢åœ¨ç­‰å¾…æœŸé–“ï¼Œæ•µäººè¢«åˆªé™¤ï¼ˆä¾‹å¦‚è¢«æ‰“æ­»ï¼‰ã€‚

## æ¸¬è©¦å ´æ™¯

### å ´æ™¯ 1ï¼šç©å®¶ç¢°æ’éœæ­¢çš„æ•µäºº

```
åˆå§‹ï¼š
  ğŸ”´ â”â”â†’ (ç©å®¶ç§»å‹•)
  ğŸ”µ     (æ•µäººéœæ­¢)

ç¢°æ’å¾Œï¼š
  ğŸ”´ â†â”  (ç©å®¶åå½ˆ)
  ğŸ”µ     (æ•µäººä¸å‹•) âœ…

é æœŸï¼šæ•µäººä½ç½®å’Œé€Ÿåº¦éƒ½ä¸è®Š
```

### å ´æ™¯ 2ï¼šç©å®¶ç¢°æ’ç§»å‹•ä¸­çš„æ•µäºº

```
åˆå§‹ï¼š
  ğŸ”´ â”â”â†’ (ç©å®¶ç§»å‹•)
  ğŸ”µ â†“   (æ•µäººå‘ä¸‹ç§»å‹•)

ç¢°æ’å¾Œï¼š
  ğŸ”´ â†â”  (ç©å®¶åå½ˆ)
  ğŸ”µ â†“   (æ•µäººç¹¼çºŒå‘ä¸‹) âœ…

é æœŸï¼šæ•µäººä¿æŒåŸæœ¬çš„ç§»å‹•æ–¹å‘å’Œé€Ÿåº¦
```

### å ´æ™¯ 3ï¼šæ•µäººç¢°æ’ç©å®¶

```
åˆå§‹ï¼š
  ğŸ”´     (ç©å®¶éœæ­¢)
  ğŸ”µ â”â†’ (æ•µäººè¡å‘ç©å®¶)

ç¢°æ’å¾Œï¼š
  ğŸ”´     (ç©å®¶ä¸å‹•) âœ…
  ğŸ”µ â†â”  (æ•µäººåå½ˆ)

é æœŸï¼šç©å®¶ä½ç½®å’Œé€Ÿåº¦éƒ½ä¸è®Š
```

### å ´æ™¯ 4ï¼šå¤šé‡ç¢°æ’

```
åˆå§‹ï¼š
  ğŸ”´ â”â”â†’ (ç©å®¶å‘å³)
  ğŸ”µ ğŸ”µ ğŸ”µ (ä¸‰å€‹æ•µäººæ’æˆä¸€åˆ—)

ç¢°æ’é †åºï¼š
  T=1: ğŸ”´ ğŸ’¥ ğŸ”µâ‚ â†’ æ•µäººâ‚ä¸å‹• âœ…
  T=2: ğŸ”´ ğŸ’¥ ğŸ”µâ‚‚ â†’ æ•µäººâ‚‚ä¸å‹• âœ…
  T=3: ğŸ”´ ğŸ’¥ ğŸ”µâ‚ƒ â†’ æ•µäººâ‚ƒä¸å‹• âœ…

çµæœï¼šæ‰€æœ‰æ•µäººä½ç½®éƒ½ä¸è®Š
```

## èˆ‡å…¶ä»–ç³»çµ±çš„é—œä¿‚

### èˆ‡ Smash çš„å·®ç•°

```
ä¸€èˆ¬ç¢°æ’ï¼š
  - åªæ¢å¾©è¢«æ“Šè€…ä½ç½®
  - æ”»æ“Šè€…æ­£å¸¸åå½ˆ

Smashï¼š
  - æ¢å¾©æ‰€æœ‰å–®ä½ä½ç½®
  - æ”»æ“Šè€…ä¹Ÿåœæ­¢ç§»å‹•
```

### èˆ‡å¼±é»ç³»çµ±çš„é—œä¿‚

```
ç¢°æ’è™•ç†æµç¨‹ï¼š
1. è¨˜éŒ„ä½ç½®å’Œé€Ÿåº¦
2. æª¢æŸ¥æ˜¯å¦å‘½ä¸­å¼±é» â† åœ¨æ¢å¾©å‰æª¢æŸ¥
3. è¨ˆç®—å‚·å®³ï¼ˆå«å¼±é»å€ç‡ï¼‰
4. é€ æˆå‚·å®³
5. æ¢å¾©ä½ç½®å’Œé€Ÿåº¦ â† ä¸å½±éŸ¿å¼±é»åˆ¤å®š
```

## ç¸½çµ

**ä¿®æ­£æ–¹æ³•**ï¼š
- åœ¨ç¢°æ’è™•ç†å‡½æ•¸ä¸­è¨˜éŒ„è¢«æ“Šè€…çš„ä½ç½®å’Œé€Ÿåº¦
- ç­‰å¾…ä¸€å¹€è®“ç‰©ç†å¼•æ“è™•ç†ç¢°æ’
- æ¢å¾©è¢«æ“Šè€…çš„ä½ç½®å’Œé€Ÿåº¦

**æ•ˆæœ**ï¼š
- âœ… è¢«æ“Šè€…ï¼ˆæ•µäººæˆ–ç©å®¶ï¼‰ä¸æœƒè¢«å½ˆé–‹
- âœ… è¢«æ“Šè€…ä¿æŒåŸæœ¬çš„ä½ç½®å’Œç§»å‹•ç‹€æ…‹
- âœ… æ”»æ“Šè€…æ­£å¸¸åå½ˆï¼ˆç¬¦åˆå½ˆç å°æ©Ÿåˆ¶ï¼‰
- âœ… ä¸å½±éŸ¿å‚·å®³è¨ˆç®—å’Œå¼±é»åˆ¤å®š

**ç¾åœ¨ç¢°æ’è¡Œç‚ºæ­£ç¢ºï¼è¢«æ”»æ“Šè€…ä¸æœƒå›å½ˆï¼** âœ…
