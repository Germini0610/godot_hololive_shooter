# 邊界牆壁修正

## 問題分析

### 原始設定問題
```
圓形單位半徑：
- Player Unit: 30 像素
- Enemy: 35 像素

原始牆壁：
- 厚度：20 像素（太薄）
- 位置：邊緣 (0, 0, 1152, 648)

問題：
┌────────────────┐  ← 牆壁厚度 20px
│                │
│  🔴 (r=30)     │  ← 圓形物體半徑 30px
│                │
└────────────────┘

當圓心在邊界時：
  🔴
 ╱ ╲
│   │ ← 圓形會超出牆壁！
└───┘
```

### 為什麼會超出？

#### 碰撞檢測原理
```
圓形碰撞體與矩形牆壁：

正確：
    牆壁足夠厚
    ┌────────┐
    │        │
    │  🔴   │  ← 圓完全在內
    │        │
    └────────┘

錯誤：
  ┌──┐  ← 牆太薄
  │🔴│  ← 圓突出
  └──┘
```

圓形的碰撞點是**圓心**，但圓的邊緣會延伸到 `圓心 ± 半徑`

## 修正方案

### 計算需求

```
最大圓形半徑 = 35 像素（Enemy）

安全邊界計算：
1. 牆壁厚度 = 半徑 × 2 + 安全距離
   = 35 × 2 + 10
   = 80 像素

2. 牆壁位置偏移 = 厚度 ÷ 2
   = 80 ÷ 2
   = 40 像素
```

### 修正內容

#### 1. 增加牆壁厚度
```gdscript
# 修正前
[sub_resource type="RectangleShape2D" id="RectangleShape2D_1"]
size = Vector2(1200, 20)  # 上下牆 - 太薄

[sub_resource type="RectangleShape2D" id="RectangleShape2D_2"]
size = Vector2(20, 700)   # 左右牆 - 太薄

# 修正後
[sub_resource type="RectangleShape2D" id="RectangleShape2D_1"]
size = Vector2(1200, 80)  # 上下牆 - 4倍厚度

[sub_resource type="RectangleShape2D" id="RectangleShape2D_2"]
size = Vector2(80, 700)   # 左右牆 - 4倍厚度
```

#### 2. 調整牆壁位置（向外移動）

**上牆**
```gdscript
# 修正前
position = Vector2(576, 0)  # 邊緣

# 修正後
position = Vector2(576, -40)  # 向上移 40px
```

**下牆**
```gdscript
# 修正前
position = Vector2(576, 648)

# 修正後
position = Vector2(576, 688)  # 向下移 40px
```

**左牆**
```gdscript
# 修正前
position = Vector2(0, 324)

# 修正後
position = Vector2(-40, 324)  # 向左移 40px
```

**右牆**
```gdscript
# 修正前
position = Vector2(1152, 324)

# 修正後
position = Vector2(1192, 324)  # 向右移 40px
```

#### 3. 調整視覺顯示（ColorRect）
```gdscript
# 修正前（上下牆）
offset_left = -600.0
offset_top = -10.0
offset_right = 600.0
offset_bottom = 10.0

# 修正後（上下牆）
offset_left = -600.0
offset_top = -40.0  # 擴大視覺範圍
offset_right = 600.0
offset_bottom = 40.0

# 修正前（左右牆）
offset_left = -10.0
offset_top = -350.0
offset_right = 10.0
offset_bottom = 350.0

# 修正後（左右牆）
offset_left = -40.0  # 擴大視覺範圍
offset_top = -350.0
offset_right = 40.0
offset_bottom = 350.0
```

## 視覺化對比

### 修正前
```
實際遊戲區域 (1152 × 648)
┌────────────────────┐  ← 牆厚 20px (太薄)
│                    │
│  🔴 可能超出邊界   │
│                    │
└────────────────────┘
```

### 修正後
```
擴大的遊戲區域 (含牆壁厚度)
┏━━━━━━━━━━━━━━━━━━━━┓  ← 牆厚 80px (足夠厚)
┃                    ┃
┃  🔴 完全在內部     ┃  ← 安全區域
┃                    ┃
┗━━━━━━━━━━━━━━━━━━━━┛

有效遊戲區域 (約 1152 × 648)
實際牆壁外緣已延伸
```

## 座標計算

### 原始邊界
```
Top:    Y = 0
Bottom: Y = 648
Left:   X = 0
Right:  X = 1152
```

### 修正後的牆壁中心
```
Top:    Y = -40   (向上延伸)
Bottom: Y = 688   (向下延伸)
Left:   X = -40   (向左延伸)
Right:  X = 1192  (向右延伸)
```

### 安全遊戲區域（圓心可到達範圍）
```
考慮最大半徑 35px：

Top:    Y = 35    (圓心最高點)
Bottom: Y = 613   (圓心最低點)
Left:   X = 35    (圓心最左點)
Right:  X = 1117  (圓心最右點)

實際可遊玩區域 ≈ 1082 × 578
```

## 物理碰撞原理

### 圓形與矩形碰撞
```
Godot 的 RigidBody2D 碰撞檢測：

當圓心位置 + 圓半徑 接觸到矩形邊緣：
    觸發碰撞
         ↓
    產生反彈力
         ↓
    圓形被推回

需要牆壁厚度 >= 2 × 半徑
才能完全包住圓形
```

### 為什麼 80 像素？
```
最大半徑 = 35 像素

理論最小厚度 = 35 × 2 = 70 像素

實際設定 = 80 像素
         = 70 + 10 (安全邊距)

原因：
- 物理引擎誤差
- 高速碰撞穿透
- 視覺緩衝區
```

## 測試要點

### 上邊界測試
```
發射單位向上
     ↑
   🔴 Y=35
   ╱ ╲
  │   │ ← 圓形頂端
  └───┘

✅ 應該反彈，不超出
```

### 下邊界測試
```
發射單位向下
     ↓
   🔴 Y=613
   ╱ ╲
  │   │ ← 圓形底端
  └───┘

✅ 應該反彈，不超出
```

### 左右邊界測試
```
向左/右發射
  ← 🔴 →

✅ 應該反彈，不超出
```

### 角落測試（最嚴格）
```
斜向發射到角落
    ↗
  🔴

圓形會同時接觸兩面牆
✅ 應該正確反彈
```

## 碰撞層設定

牆壁應該與所有物體碰撞：
```gdscript
StaticBody2D 預設：
- collision_layer = 1
- collision_mask = 0

實際效果：
- 所有 RigidBody2D 的 collision_mask 包含 layer 1
- 所以會與玩家和敵人碰撞 ✅
```

## 效能影響

### 增加牆壁厚度的影響
```
修正前：
- 4 面牆，每面 20px
- 碰撞計算負擔：極小

修正後：
- 4 面牆，每面 80px
- 碰撞計算負擔：仍然極小

原因：
- StaticBody2D 不參與物理模擬
- 只有碰撞檢測
- 矩形碰撞檢測是 O(1)
- 影響可忽略不計 ✓
```

## 總結

### 修正前
- ❌ 牆壁太薄（20px）
- ❌ 圓形物體會超出邊界
- ❌ 視覺不一致

### 修正後
- ✅ 牆壁加厚（80px）
- ✅ 位置向外偏移（40px）
- ✅ 圓形物體完全包含在內
- ✅ 視覺與碰撞一致

**現在所有圓形物體都會正確地停留在邊界內！** 🎯
